{{define "order"}}
<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://unpkg.com/htmx.org@1.9.5"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>
    <meta charset="UTF-8">
    <title>order - {{.Order.ID}}</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/table.css">
    <link rel="stylesheet" href="/static/css/searchbar.css">
</head>

<body>
    {{ template "header" .}}
    <div class="container">
        <h1>{{.Order.ID}}: {{firstLine .Order.Objective}}</h1>

        <div>
            <a href="/order/{{.ParentOrder.ID}}">Parent Order:</a>
            <input type="text" class="text-input" id="parent-order-id" name="order-task"
                value="{{.Order.ParentOrderID}}: {{firstLine .ParentOrder.Objective}}" />
        </div>

        <div>
            <label for="task-objective">Objective:</label>
            <textarea class="text-input" id="task-objective" name="order-task" required>{{.Order.Objective}}</textarea>
        </div>

        <div>
            <a href="/user/{{.AccountableUser.ID}}">Accountable:</a>
            <input type="text" class="text-input" id="task-accountable" name="order-task"
                value="{{.AccountableUser.Email}}" />
        </div>

        <div>
            <strong>Deadline:</strong>
            <input type="date" id="task-deadline" name="order-task" value="{{formatToDate .Order.Deadline}}" required>
        </div>

        <div>
            <strong>State:</strong>
            <select id="task-state" name="order-task" style="border: none;" required>
                {{range States}}
                <option value="{{.}}" {{if eq . $.Order.State}}selected{{end}}>{{.}}</option>
                {{end}}
            </select>
        </div>

        <details open>
            <summary>
                Delegated Orders
                <button id="addDelegatedOrderFormBtn" style="margin-left: 10px;">+</button>
                <div id="delegatedOrderFormContainer"></div>
            </summary>
            <input class="searchbar" type="text" id="searchInput" placeholder="Search...">

            <div class="scroll-container">
                <table class="styled-table" id="datatable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Objective</th>
                            <th>Accountable</th>
                            <th>Deadline</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .DelegatedOA}}
                        <tr>
                            <td><a href="/order/{{.Order.ID}}">{{.Order.ID}}</a></td>
                            <td>{{.Order.Objective}}</td>
                            <td><a href="/user/{{.AccountableUser.ID}}">{{.AccountableUser.Email}}</a></td>
                            <td>{{formatToDate .Order.Deadline}}</td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </details>

        <details open>
            <summary>
                SitReps
                <button id="addSitRepFormBtn" style="margin-left: 10px;">+</button>
                <div id="sitrepFormContainer"></div>
            </summary>
            <div id="sitreps">
                {{range .Order.SitReps}}
                <div>
                    <details class="card" open>
                        <summary id="sitrep-{{.ID}}-summary"
                            style="font-size: 0.9em; font-weight: 300; cursor: pointer; color: #555;">{{.DateTime}} by
                            <a href="/user/{{.By}}">{{.By}}</a></summary> <!-- TODO: get user info-->

                        <div id="sitrep-{{.ID}}-body">
                            <div>
                                <label for="sitrep-situation-{{.ID}}">Situation:</label>
                                <textarea class="text-input" id="sitrep-situation-{{.ID}}" name="order-sitrep"
                                    placeholder="Situation to date...">{{.Situation}}</textarea>
                            </div>

                            <div>
                                <label for="sitrep-actions-{{.ID}}">Actions:</label>
                                <textarea class="text-input" id="sitrep-actions-{{.ID}}" name="order-sitrep"
                                    placeholder="Actions to date...">{{.Actions}}</textarea>
                            </div>

                            <div>
                                <label for="sitrep-todo-{{.ID}}">TODO:</label>
                                <textarea class="text-input" id="sitrep-todo-{{.ID}}" name="order-sitrep"
                                    placeholder="Things to do...">{{.TODO}}</textarea>
                            </div>

                            <div>
                                <label for="sitrep-issues-{{.ID}}">Issues:</label>
                                <textarea class="text-input" id="sitrep-issues-{{.ID}}" name="order-sitrep"
                                    placeholder="Issues...">{{.Issues}}</textarea>
                            </div>

                        </div>
                    </details>
                </div>
                {{end}}
            </div>
        </details>
    </div>

    <script src="/static/scripts/table_utils.js"></script>
    <script>
        document.getElementById('addDelegatedOrderFormBtn').addEventListener('click', async function () {
            const formContainer = document.getElementById('delegatedOrderFormContainer');

            if (formContainer.querySelector('div')) return;

            // Create the form
            const form = document.createElement('div');

            form.innerHTML = `
    <hr />
    <div>
        <label for="new-delegated-order-objective">Objective:</label>
        <textarea class="text-input" id="new-delegated-order-objective" required></textarea>
    </div>

    <div>
        <label for="new-delegated-order-accountable">Accountable:</label>
        <input type="text" id="new-delegated-order-accountable"/>
    </div>

    <div>
        <label for="new-delegated-order-deadline">Deadline:</label>
        <input type="date" id="new-delegated-order-deadline" required>
    </div>

    <button type="button" id="saveDelegatedOrderBtn">✓</button>
    <button type="button" id="cancelDelegatedOrderBtn">×</button>
    <hr />`;
            formContainer.appendChild(form);

            form.querySelector('#saveDelegatedOrderBtn').addEventListener('click', async function () {
                const objective = document.getElementById('new-delegated-order-objective')?.value?.trim();
                const accountable = document.getElementById('new-delegated-order-accountable')?.value?.trim();
                const deadline = document.getElementById('new-delegated-order-deadline')?.value?.trim();

                if (!objective || !accountable || !deadline) {
                    alert('Please fill all fields.');
                    return;
                }
                try {

                    const getResponse = await fetch(`/v1/mgmt/users?emails=${encodeURIComponent(accountable)}`);
                    const respGetSupervisorList = await getResponse.json();
                    if (!getResponse.ok || respGetSupervisorList?.users && respGetSupervisorList?.users.length == 0) {
                        alert(`user with email "${accountable}" doesn't exist`)
                        return
                    }

                    let user = respGetSupervisorList?.users[0];

                    let response = await fetch('/v1/mgmt/order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            order: {
                                parent_order_id: "{{.Order.ID}}",
                                objective: objective,
                                accountable_id: user?.id,
                                state: "Delegated",
                                deadline: deadline + "T00:00:00Z",
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Server error: ' + response.statusText);
                    }

                    const respPostOrder = await response.json();

                    const tableBody = document.querySelectorAll('#datatable tbody')[0];
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
        <td><a href="/order/${respPostOrder?.order?.id}">${respPostOrder?.order?.id}</a></td>
        <td>${respPostOrder?.order?.objective}</td>
        <td><a href="/user/${user?.id}">${user?.email}</a></td>
        <td>${deadline}</td>
    `;
                    tableBody.appendChild(newRow);

                    form.remove();
                } catch (err) {
                    alert('Creating new delegated order failed:', err);
                }
            });


            // Cancel/delete button
            form.querySelector('#cancelDelegatedOrderBtn').addEventListener('click', function () {
                form.remove();
            });
        });


        document.getElementById('addSitRepFormBtn').addEventListener('click', async function () {
            const formContainer = document.getElementById('sitrepFormContainer');

            if (formContainer.querySelector('div')) return;

            // Create the form
            const form = document.createElement('div');

            form.innerHTML = `
    <hr />
    <div>
        <label for="new-sitrep-situation">Situation:</label>
        <textarea class="text-input" id="new-sitrep-situation" required placeholder="Situation to date/What has happened"></textarea>
    </div>

    <div>
        <label for="new-sitrep-actions">Actions:</label>
        <textarea class="text-input" id="new-sitrep-actions" required placeholder="Actions to date/What has been done"></textarea>
    </div>

    <div>
        <label for="new-sitrep-todo">TODO:</label>
        <textarea class="text-input" id="new-sitrep-todo" required placeholder="Actions to be completed/What will be done"></textarea>
    </div>

    <div>
        <label for="new-sitrep-issues">Issues:</label>
        <textarea class="text-input" id="new-sitrep-issues" required placeholder="Encountered issues"></textarea>
    </div>

    <button type="button" id="saveSitRepBtn">✓</button>
    <button type="button" id="cancelSitRepBtn">×</button>
    <hr />`;
            formContainer.appendChild(form);

            form.querySelector('#saveSitRepBtn').addEventListener('click', async function () {
                const situation = document.getElementById('new-sitrep-situation')?.value?.trim();
                const actions = document.getElementById('new-sitrep-actions')?.value?.trim();
                const todo = document.getElementById('new-sitrep-todo')?.value?.trim();
                const issues = document.getElementById('new-sitrep-issues')?.value?.trim();
                const by = "todo@email.com"
                const datetime = new Date().toISOString();


                if (!situation && !actions && !todo && !issues) {
                    alert('Please fill at least 1 field.');
                    return;
                }
                try {

                    let response = await fetch('/v1/mgmt/order/{{.Order.ID}}/sitrep', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            sitreps: [
                                {
                                    by: by,
                                    datetime: datetime,
                                    situation: situation,
                                    actions: actions,
                                    todo: todo,
                                    issues: issues,
                                }
                            ]
                        })
                    });

                    if (!response.ok) {
                        console.log("HERE")
                        throw new Error('Server error: ' + response.statusText);
                    }

                    const respPutSitrep = await response.json();
                    const sitrep = respPutSitrep?.order?.sitreps.at(-1);
                    if (!sitrep) {
                        throw new Error('Unexpected sitreps length');
                    }

                    const cardsList = document.querySelector('#sitreps');
                    const newCard = document.createElement('div');
                    newCard.innerHTML = `
                <details class="card" open>
                    <summary id="sitrep-${sitrep?.id || ""}-summary"
                        style="font-size: 0.9em; font-weight: 300; cursor: pointer; color: #555;">${datetime} by <a
                            href="/user/${by}">${by}</a></summary> <!-- TODO: correct by user -->
    
                    <div id="sitrep-${sitrep?.id || ""}-body">
                        <div>
                            <label for="sitrep-situation-${sitrep?.id || ""}">Situation:</label>
                            <textarea class="text-input" id="sitrep-situation-${sitrep?.id || ""}" name="order-sitrep"
                                placeholder="Situation to date...">${sitrep?.situation || ""}</textarea>
                        </div>
    
                        <div>
                            <label for="sitrep-actions-${sitrep?.id || ""}">Actions:</label>
                            <textarea class="text-input" id="sitrep-actions-${sitrep?.id || ""}" name="order-sitrep"
                                placeholder="Actions to date...">${sitrep?.actions || ""}</textarea>
                        </div>
    
                        <div>
                            <label for="sitrep-todo-${sitrep?.id || ""}">TODO:</label>
                            <textarea class="text-input" id="sitrep-todo-${sitrep?.id || ""}" name="order-sitrep"
                                placeholder="Things to do...">${sitrep?.todo || ""}</textarea>
                        </div>
    
                        <div>
                            <label for="sitrep-issues-${sitrep?.id || ""}">Issues:</label>
                            <textarea class="text-input" id="sitrep-issues-${sitrep?.id || ""}" name="order-sitrep"
                                placeholder="Issues...">${sitrep?.issues || ""}</textarea>
                        </div>
                    </div>
                </details>
    `;
                    cardsList.appendChild(newCard);

                    form.remove();
                } catch (err) {
                    alert('Creating sitrep failed:', err);
                }
            });


            // Cancel/delete button
            form.querySelector('#cancelSitRepBtn').addEventListener('click', function () {
                form.remove();
            });
        });
    </script>

    {{ template "footer" .}}

</body>

</html>
{{end}}