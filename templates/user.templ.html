{{define "user"}}
<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://unpkg.com/htmx.org@1.9.5"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>
    <meta charset="UTF-8">
    <title>user - {{.User.ID}}</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/table.css">
    <link rel="stylesheet" href="/static/css/searchbar.css">

</head>

<body>
    {{ template "header" .}}
    <div class="container">
        <details class="card" open>
            <summary>
                Info

                <button class="delete-btn" hx-delete="/v1/mgmt/user/{{.User.ID}}"
                    hx-confirm="Are you sure you want to delete this user?"
                    hx-on="htmx:afterRequest: if (event.detail.xhr.status === 200) window.location.href = '/user/{{.User.SupervisorID}}';">
                    ×
                </button>
            </summary>

            <b>ID: </b>{{.User.ID}}<br>
            <b>Email:</b> {{.User.Email}}<br>

            <div>
                <label for="user-supervisor">
                    <span id="supervisor-link">
                        <a href="/user/{{.Supervisor.ID}}">Supervisor:</a>
                    </span>
                </label>

                <input type="text" class="text-input" id="user-supervisor" name="supervisor"
                    value="{{.Supervisor.Email}}" placeholder="Enter supervisor email and press Enter">
            </div>

        </details>

        <hr style="border: none; height: 2px; background-color: #333; width: 50%; margin: 20px auto;">

        <div>
            <input class="searchbar" type="text" id="searchInput" placeholder="Search...">
        </div>

        <details open>
            <summary>Accountable for</summary>
            <div class="scroll-container">
                <table class="styled-table" id="datatable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Objective</th>
                            <th>State</th>
                            <th>Deadline</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .AccountableFor}}
                        <tr>
                            <td><a href="/order/{{.ID}}">{{.ID}}</a></td>
                            <td>{{firstLine .Objective}}</td>
                            <td>{{.State}}</td>
                            <td>{{formatToDate .Deadline}}</td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </details>

        <details open>
            <summary id="subordinatesSummary">
                Sub-Ordinates
                <button id="addFormBtn" style="margin-left: 10px;">+</button>
                <div id="emailFormContainer"></div>
            </summary>
            <div class="scroll-container">
                <table class="styled-table" id="datatable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .SubOrdinates}}
                        <tr>
                            <td><a href="/user/{{.ID}}">{{.ID}}</a></td>
                            <td>{{.Email}}</td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </details>


        {{ template "footer" .}}

        <script src="/static/scripts/table_utils.js"></script>
        <script>
            // FIXME:
            function updateSupervisorLink(responseText) {
                const data = JSON.parse(responseText);
                const params = new URLSearchParams({
                    emails: [data.user?.supervisor],
                });
                fetch(`/v1/mgmt/users?${params.toString()}`)
                    .then(response => response.json())
                    .then(resp => {
                        if (resp?.users?.length >= 1) {
                            const linkContainer = document.getElementById("supervisor-link");
                            linkContainer.innerHTML = `<a href="/user/${resp?.users[0]?.id}">Supervisor:</a>`;
                        }
                    })
                    .catch(err => console.error("Error:", err));
            }


            document.getElementById('addFormBtn').addEventListener('click', function () {
                const formContainer = document.getElementById('emailFormContainer');

                if (formContainer.querySelector('div')) return;

                // Create the form
                const form = document.createElement('div');

                form.innerHTML = `
    <label>Email:</label>
    <input type="email" id="newEmail" required placeholder="Enter email">
    <button type="button" id="saveEmailBtn">✓</button>
    <button type="button" id="cancelEmailBtn">×</button>
  `;
                form.querySelector('#newEmail').addEventListener('keypress', e => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        form.querySelector('#saveEmailBtn').click();
                    }
                });
                formContainer.appendChild(form);

                form.querySelector('#saveEmailBtn').addEventListener('click', async function () {
                    const emailInput = document.getElementById('newEmail');
                    const email = emailInput.value.trim();

                    if (!email) {
                        alert('Please enter an email address.');
                        return;
                    }

                    try {

                        let response;

                        const getResponse = await fetch(`/v1/mgmt/users?emails=${encodeURIComponent(email)}`);
                        const respGetSupervisorList = await getResponse.json();
                        if (getResponse.ok && respGetSupervisorList?.users && respGetSupervisorList?.users.length == 1) { // exists, update user

                            response = respGetSupervisorList?.users[0];
                            const currentUserId = "{{.User.ID}}";

                            response = await fetch('/v1/mgmt/user', {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    user: {
                                        id: response?.id,
                                        supervisor_id: currentUserId
                                    }
                                })
                            });
                        } else {
                            response = await fetch('/v1/mgmt/user', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    user: {
                                        email: email,
                                        supervisor_id: "{{.User.ID}}",
                                    }
                                })
                            });
                        }

                        if (!response.ok) {
                            throw new Error('Server error: ' + response.statusText);
                        }

                        const newSubordinate = await response.json();

                        const tableBody = document.querySelectorAll('#datatable tbody')[1];
                        const newRow = document.createElement('tr');
                        const newId = newSubordinate?.user?.id
                        newRow.innerHTML = `
      <td><a href="/user/${newId}">${newId}</a></td>
      <td>${email}</td>
    `;
                        tableBody.appendChild(newRow);

                        form.remove();
                    } catch (err) {
                        console.error('Error saving subordinate:', err);
                        alert('Failed to save subordinate.');
                    }
                });

                // Cancel/delete button
                form.querySelector('#cancelEmailBtn').addEventListener('click', function () {
                    form.remove();
                });
            });

            document.addEventListener('DOMContentLoaded', () => {
                const supervisorInput = document.getElementById('user-supervisor');
                const supervisorLink = document.getElementById('supervisor-link');
                const currentUserId = "{{.User.ID}}";

                supervisorInput.addEventListener('keyup', async (event) => {
                    if (event.key !== 'Enter') return;

                    const email = supervisorInput.value.trim();
                    if (!email) {
                        alert('Please enter a supervisor email.');
                        return;
                    }

                    try {
                        const getResponse = await fetch(`/v1/mgmt/users?emails=${encodeURIComponent(email)}`);
                        if (!getResponse.ok) {
                            throw new Error('Supervisor not found.');
                        }

                        const respGetSupervisorList = await getResponse.json();
                        if (respGetSupervisorList.length == 0) {
                            throw new Error('Supervisor not found.');
                            return;
                        }
                        const respGetSupervisor = respGetSupervisorList?.users[0];

                        const updateResponse = await fetch('/v1/mgmt/user', {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                user: {
                                    id: currentUserId,
                                    supervisor_id: respGetSupervisor?.id
                                }
                            })
                        });

                        if (!updateResponse.ok) {
                            throw new Error('Failed to update supervisor.');
                            return;
                        }

                        supervisorLink.innerHTML = `<a href="/user/${respGetSupervisor?.id}">Supervisor:</a>`;
                        supervisorInput.value = respGetSupervisor?.email;

                        // console.log(`Supervisor updated: ${supervisor.email} (ID: ${supervisor.id})`);

                    } catch (error) {
                        console.error('Error updating supervisor:', error);
                        alert(error.message);
                    }
                });
            });
        </script>
</body>

</html>
{{end}}